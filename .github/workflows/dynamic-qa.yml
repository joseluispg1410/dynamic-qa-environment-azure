# GitHub Actions workflow for Dynamic QA Environment
# This workflow provisions infrastructure in Azure, deploys a sample app,
# runs Playwright tests, and cleans up resources automatically.

name: Dynamic QA Environment

# Trigger the workflow manually or on PRs
on:
  workflow_dispatch:
  pull_request:
    branches:
        - main

jobs:
  qa:
    runs-on: ubuntu-latest

    # Environment variables shared across steps
    env:
      TF_VAR_env_name: qa-${{ github.run_id }} # Unique QA environment name
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

    steps:
      # Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Debug Workspace
      - name: Debug workspace
        run: |
         echo "workspace=$GITHUB_WORKSPACE"
         pwd
         ls -la
         ls -la ./terraform || true
         find . -maxdepth 2 -name "*.tf" -print

      # Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.9.8
          terraform_wrapper: false

      # Initialize and apply Terraform to provision infra
      - name: Terraform Init & Apply
        id: terraform
        working-directory: ./terraform
        run: |
          terraform init
          terraform apply -auto-approve

      - name: Get Terraform outputs
        id: tf-output
        working-directory: ./terraform  
        run: |
          echo "APP_URL=$(terraform output -raw app_url)" >> $GITHUB_OUTPUT

      - name: Wait for app readiness
        run: |
          APP_URL="https://${{ steps.tf-output.outputs.APP_URL }}"
          echo "Waiting for $APP_URL"
          for i in $(seq 1 30); do
            code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 "$APP_URL" || echo "000")
            if [ "$code" -eq 200 ]; then
              echo "App is ready (HTTP 200)"
              break
            fi
            echo "Attempt $i: HTTP $code â€” sleeping 10s"
            sleep 10
          done
          if [ "$code" != "200" ]; then
            echo "App not ready after 30 attempts"
            curl -v "$APP_URL" || true
            exit 1
          fi

      # Run Playwright tests inside Docker with Allure results
      - name: Run Playwright Tests
        run: |
          echo "BASE_URL=https://${{ steps.tf-output.outputs.APP_URL }}"
          docker build -t playwright-tests ./tests
          docker run \
            -e BASE_URL="https://${{ steps.tf-output.outputs.APP_URL }}" \
            -v ${{ github.workspace }}/allure-results:/tests/allure-results \
            playwright-tests

      # Generate Allure report (outside the container)
      - name: Generate Allure report
        if: always()
        run: |
          npm install -D allure-commandline
          npx allure generate allure-results --clean -o allure-report

      # Upload Allure like Artifact (URL Ãºnica por run)
      - name: Deploy Allure to GitHub Pages (per run folder)
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report
          publish_branch: gh-pages
          destination_dir: runs/${{ github.run_id }}   # <- clave
          user_name: "github-actions"
          user_email: "github-actions@github.com"
          keep_files: true         

      # Comment on PR with direct link to the report
      - name: Comment PR with Allure Pages link
        if: always() && github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ðŸ“Š **Allure Report #${{ github.run_number }}**
            [Abrir reporte](https://joseluispg1410.github.io/dynamic-qa-environment-azure/runs/${{ github.run_id }}/)
            
            ðŸŸ¢ Tests: ${{ job.status == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}
            
            ðŸ’» App URL: https://${{ steps.tf-output.outputs.APP_URL }}

      # Cleanup: destroy Terraform-managed resources
      - name: Terraform Destroy
        if: always()  # Always runs even if tests fail
        working-directory: ./terraform
        run: |
          terraform init -input=false
          terraform destroy -auto-approve
